@page "/"
@using System.Globalization
@inject IProdutoService ProdutoService
@inject ICategoriaService CategoriaService
@inject ICarrinhoService CarrinhoService
@inject NavigationManager Navigation

<PageTitle>MyCOLL - Colecionáveis</PageTitle>

<div class="home-page">
    <!-- Produto em Destaque -->
    @if (produtoDestaque != null)
    {
        <section class="hero-section">
            <div class="hero-content">
                <div class="hero-image">
                    <img src="@produtoDestaque.ImagemUrl" alt="@produtoDestaque.Nome" />
                </div>
                <div class="hero-info">
                    <span class="destaque-badge">? Em Destaque</span>
                    <h1>@produtoDestaque.Nome</h1>
                    <p class="hero-desc">@produtoDestaque.Detalhe</p>
                    <div class="hero-price">
                        <span class="price">@FormatarPreco(produtoDestaque.Preco)</span>
                        @if (produtoDestaque.PrecoBase != produtoDestaque.Preco)
                        {
                            <span class="price-base">@FormatarPreco(produtoDestaque.PrecoBase)</span>
                        }
                    </div>
                    <div class="hero-actions">
                        <button class="btn-primary" @onclick="() => VerProduto(produtoDestaque.Id)">
                            Ver Detalhes
                        </button>
                        @if (produtoDestaque.PodeComprar)
                        {
                            <button class="btn-secondary" @onclick="() => AdicionarAoCarrinho(produtoDestaque)">
                                ?? Adicionar
                            </button>
                        }
                    </div>
                </div>
            </div>
        </section>
    }

    <!-- Sliders de Categorias -->
    <section class="categorias-section">
        <h2>Explorar por Categoria</h2>
        
        <!-- Nível 1: Tipos -->
        <div class="categoria-slider">
            @foreach (var categoria in categoriasRaiz)
            {
                <div class="categoria-card @(categoriaSelecionada1?.Id == categoria.Id ? "selected" : "")" 
                     @onclick="() => SelecionarCategoriaNivel1(categoria)">
                    <img src="@categoria.ImagemUrl" alt="@categoria.Nome" />
                    <span>@categoria.Nome</span>
                </div>
            }
        </div>

        <!-- Nível 2: Subcategorias do Nível 1 -->
        @if (subcategoriasNivel2.Any())
        {
            <div class="categoria-slider nivel-2">
                @foreach (var categoria in subcategoriasNivel2)
                {
                    <div class="categoria-card @(categoriaSelecionada2?.Id == categoria.Id ? "selected" : "")"
                         @onclick="() => SelecionarCategoriaNivel2(categoria)">
                        <img src="@categoria.ImagemUrl" alt="@categoria.Nome" />
                        <span>@categoria.Nome</span>
                    </div>
                }
            </div>
        }

        <!-- Nível 3: Subcategorias do Nível 2 -->
        @if (subcategoriasNivel3.Any())
        {
            <div class="categoria-slider nivel-3">
                @foreach (var categoria in subcategoriasNivel3)
                {
                    <div class="categoria-card @(categoriaSelecionada3?.Id == categoria.Id ? "selected" : "")"
                         @onclick="() => SelecionarCategoriaNivel3(categoria)">
                        <img src="@categoria.ImagemUrl" alt="@categoria.Nome" />
                        <span>@categoria.Nome</span>
                    </div>
                }
            </div>
        }
    </section>

    <!-- Produtos da categoria selecionada ou todos -->
    <section class="produtos-section">
        <div class="section-header">
            <h2>
                @if (categoriaAtiva != null)
                {
                    @categoriaAtiva.Nome
                }
                else
                {
                    <text>Produtos Disponíveis</text>
                }
            </h2>
            @if (categoriaAtiva != null)
            {
                <button class="btn-link" @onclick="LimparFiltros">Ver todos</button>
            }
        </div>

        @if (isLoading)
        {
            <div class="loading">
                <div class="spinner"></div>
                <p>A carregar produtos...</p>
            </div>
        }
        else if (!produtos.Any())
        {
            <div class="empty-state">
                <p>Nenhum produto encontrado nesta categoria.</p>
            </div>
        }
        else
        {
            <div class="produtos-grid">
                @foreach (var produto in produtos)
                {
                    <div class="produto-card">
                        <div class="produto-image" @onclick="() => VerProduto(produto.Id)">
                            <img src="@produto.ImagemUrl" alt="@produto.Nome" />
                            @if (!produto.TemStock)
                            {
                                <span class="badge-esgotado">Esgotado</span>
                            }
                        </div>
                        <div class="produto-info">
                            <h3 @onclick="() => VerProduto(produto.Id)">@produto.Nome</h3>
                            <p class="produto-categorias">@string.Join(" • ", produto.Categorias)</p>
                            <div class="produto-footer">
                                <span class="produto-preco">@FormatarPreco(produto.Preco)</span>
                                @if (produto.PodeComprar)
                                {
                                    <button class="btn-add-cart" @onclick="() => AdicionarAoCarrinho(produto)" style="display: inline-flex; align-items: center; justify-content: center; gap: 5px;">

                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                                            <path d="M2.25 2.25a.75.75 0 0 0 0 1.5h1.386c.17 0 .318.114.362.278l2.558 9.592a3.752 3.752 0 0 0-2.806 3.63c0 .414.336.75.75.75h15.75a.75.75 0 0 0 0-1.5H5.378A2.25 2.25 0 0 1 7.5 15h11.218a.75.75 0 0 0 .674-.421 60.358 60.358 0 0 0 2.96-7.228.75.75 0 0 0-.525-.965A60.864 60.864 0 0 0 5.68 4.509l-.232-.867A1.875 1.875 0 0 0 3.636 2.25H2.25ZM3.75 20.25a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM16.5 20.25a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0Z" />
                                        </svg>
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </section>
</div>

@code {
    private static readonly CultureInfo CulturaEuro = new("pt-PT");
    
    private ProdutoModel? produtoDestaque;
    private List<CategoriaModel> categoriasRaiz = new();
    private List<CategoriaModel> subcategoriasNivel2 = new();
    private List<CategoriaModel> subcategoriasNivel3 = new();
    private CategoriaModel? categoriaSelecionada1;
    private CategoriaModel? categoriaSelecionada2;
    private CategoriaModel? categoriaSelecionada3;
    private CategoriaModel? categoriaAtiva;
    private List<ProdutoModel> produtos = new();
    private bool isLoading = true;

    private string FormatarPreco(decimal preco) => preco.ToString("C", CulturaEuro);

    protected override async Task OnInitializedAsync()
    {
        // Carregar dados em paralelo
        var tarefas = new List<Task>
        {
            CarregarProdutoDestaqueAsync(),
            CarregarCategoriasAsync(),
            CarregarProdutosAsync()
        };

        await Task.WhenAll(tarefas);
        isLoading = false;
    }

    private async Task CarregarProdutoDestaqueAsync()
    {
        produtoDestaque = await ProdutoService.GetProdutoDestaqueAsync();
    }

    private async Task CarregarCategoriasAsync()
    {
        categoriasRaiz = await CategoriaService.GetCategoriasRaizAsync();
    }

    private async Task CarregarProdutosAsync(int? categoriaId = null)
    {
        isLoading = true;
        StateHasChanged();
        
        if (categoriaId.HasValue)
        {
            produtos = await ProdutoService.GetProdutosPorCategoriaAsync(categoriaId.Value);
        }
        else
        {
            produtos = await ProdutoService.GetProdutosAsync();
        }
        
        isLoading = false;
    }

    private async Task SelecionarCategoriaNivel1(CategoriaModel categoria)
    {
        categoriaSelecionada1 = categoria;
        categoriaSelecionada2 = null;
        categoriaSelecionada3 = null;
        
        categoriaAtiva = categoria;

        
        // Carregar produtos da categoria
        await CarregarProdutosAsync(categoria.Id);
    }

    private async Task SelecionarCategoriaNivel2(CategoriaModel categoria)
    {
        categoriaSelecionada2 = categoria;
        categoriaSelecionada3 = null;
        categoriaAtiva = categoria;
        
        // Carregar produtos da categoria
        await CarregarProdutosAsync(categoria.Id);
    }

    private async Task SelecionarCategoriaNivel3(CategoriaModel categoria)
    {
        categoriaSelecionada3 = categoria;
        categoriaAtiva = categoria;
        
        // Carregar produtos da categoria
        await CarregarProdutosAsync(categoria.Id);
    }

    private async Task LimparFiltros()
    {
        categoriaSelecionada1 = null;
        categoriaSelecionada2 = null;
        categoriaSelecionada3 = null;
        subcategoriasNivel2 = new();
        subcategoriasNivel3 = new();
        categoriaAtiva = null;
        
        await CarregarProdutosAsync();
    }

    private void VerProduto(int id)
    {
        Navigation.NavigateTo($"/Produtos/{id}");
    }

    private void AdicionarAoCarrinho(ProdutoModel produto)
    {
        CarrinhoService.AdicionarProduto(produto);
    }
}
