@page "/meus-produtos"
@using System.Globalization
@inject IFornecedorService FornecedorService
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Meus Produtos - MyCOLL</PageTitle>

<div class="meus-produtos-page">
    <div class="page-header">
        <h1>?? Meus Produtos</h1>
        <button class="btn-primary" @onclick="CriarNovoProduto">
            ? Novo Produto
        </button>
    </div>

    @if (!string.IsNullOrEmpty(mensagem))
    {
        <div class="alert @(sucesso ? "alert-success" : "alert-error")">
            @mensagem
            <button class="alert-close" @onclick="() => mensagem = null">×</button>
        </div>
    }

    @if (isLoading)
    {
        <div class="loading">
            <div class="spinner"></div>
            <p>A carregar produtos...</p>
        </div>
    }
    else if (!produtos.Any())
    {
        <div class="empty-state">
            <span class="empty-icon">??</span>
            <h2>Ainda não tem produtos</h2>
            <p>Comece a vender os seus colecionáveis adicionando o primeiro produto.</p>
            <button class="btn-primary" @onclick="CriarNovoProduto">
                ? Adicionar Primeiro Produto
            </button>
        </div>
    }
    else
    {
        <!-- Filtros -->
        <div class="filtros-section">
            <div class="filtro-grupo">
                <label>Estado:</label>
                <select @bind="filtroEstado" @bind:after="AplicarFiltros">
                    <option value="">Todos</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Ativo">Ativo</option>
                    <option value="Inativo">Inativo</option>
                    <option value="Suspenso">Suspenso</option>
                </select>
            </div>
            <div class="filtro-grupo">
                <input type="text" placeholder="Pesquisar por nome..." 
                       @bind="filtroPesquisa" @bind:after="AplicarFiltros" />
            </div>
        </div>

        <!-- Lista de Produtos -->
        <div class="produtos-lista">
            @foreach (var produto in produtosFiltrados)
            {
                <div class="produto-item">
                    <div class="produto-imagem">
                        <img src="@produto.ImagemUrl" alt="@produto.Nome" />
                    </div>
                    <div class="produto-info">
                        <h3>@produto.Nome</h3>
                        <p class="produto-desc">@TruncarTexto(produto.Detalhe, 100)</p>
                        <div class="produto-meta">
                            <span class="meta-item">
                               Preco Base: @FormatarPreco(produto.PrecoBase)
                            </span>
                            @if (produto.Estado == "Ativo")
                            {
                                <span class="meta-item">
                                    Preco Final: @FormatarPreco(produto.Preco)
                                </span>
                            }
                            <span class="meta-item">
                                Em Stock: @produto.Stock
                            </span>
                        </div>
                    </div>
                    <div class="produto-estado">
                        <span class="estado-badge @GetEstadoClasse(produto.Estado)">
                            @GetEstadoIcone(produto.Estado) @produto.Estado
                        </span>
                    </div>
                    <div class="produto-acoes">
                        <button class="btn-icon" title="Editar" @onclick="() => EditarProduto(produto.Id)">
                            ??
                        </button>
                        @if (produto.Estado == "Ativo" || produto.Estado == "Pendente")
                        {
                            <button class="btn-icon btn-warning" title="Suspender" 
                                    @onclick="() => SuspenderProduto(produto)">
                                ??
                            </button>
                        }
                        @if (produto.Estado == "Suspenso")
                        {
                            <button class="btn-icon btn-success" title="Reativar" 
                                    @onclick="() => ReativarProduto(produto)">
                                ??
                            </button>
                        }
                        <button class="btn-icon btn-danger" title="Apagar" 
                                @onclick="() => ApagarProduto(produto)">
                            ???
                        </button>
                    </div>
                </div>
            }
        </div>

        <!-- Legenda de Estados -->
        <div class="estados-legenda">
            <h4>Legenda de Estados:</h4>
            <div class="legenda-items">
                <span><span class="estado-badge estado-pendente">? Pendente</span> - Aguarda aprovação</span>
                <span><span class="estado-badge estado-ativo">? Ativo</span> - Visível para clientes</span>
                <span><span class="estado-badge estado-inativo">? Inativo</span> - Desativado pela administração</span>
                <span><span class="estado-badge estado-suspenso">?? Suspenso</span> - Suspenso por si</span>
            </div>
        </div>
    }
</div>

<!-- Modal de Confirmação -->
@if (mostrarModalConfirmacao)
{
    <div class="modal-overlay" @onclick="FecharModal">
        <div class="modal-content" @onclick:stopPropagation>
            <h2>@tituloModal</h2>
            <p>@mensagemModal</p>
            <div class="modal-actions">
                <button class="btn-secondary" @onclick="FecharModal">Cancelar</button>
                <button class="btn-danger" @onclick="ConfirmarAcao">Confirmar</button>
            </div>
        </div>
    </div>
}

@code {
    private static readonly CultureInfo CulturaEuro = new("pt-PT");
    
    private List<ProdutoModel> produtos = new();
    private List<ProdutoModel> produtosFiltrados = new();
    private bool isLoading = true;
    private string? mensagem;
    private bool sucesso;
    
    // Filtros
    private string filtroEstado = "";
    private string filtroPesquisa = "";
    
    // Modal
    private bool mostrarModalConfirmacao;
    private string tituloModal = "";
    private string mensagemModal = "";
    private Func<Task>? acaoConfirmacao;

    protected override async Task OnInitializedAsync()
    {
        // Verificar se está autenticado como fornecedor
        var isAuth = await AuthService.IsAuthenticatedAsync();
        if (!isAuth)
        {
            Navigation.NavigateTo("/login?returnUrl=/meus-produtos");
            return;
        }

        var userInfo = await AuthService.GetUserInfoAsync();
        if (userInfo?.IsFornecedor != true)
        {
            Navigation.NavigateTo("/");
            return;
        }

        await CarregarProdutos();
    }

    private async Task CarregarProdutos()
    {
        isLoading = true;
        produtos = await FornecedorService.GetMeusProdutosAsync();
        AplicarFiltros();
        isLoading = false;
    }

    private void AplicarFiltros()
    {
        produtosFiltrados = produtos
            .Where(p => string.IsNullOrEmpty(filtroEstado) || p.Estado == filtroEstado)
            .Where(p => string.IsNullOrEmpty(filtroPesquisa) || 
                        p.Nome.Contains(filtroPesquisa, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private void CriarNovoProduto()
    {
        Navigation.NavigateTo("/meus-produtos/criar");
    }

    private void EditarProduto(int id)
    {
        Navigation.NavigateTo($"/meus-produtos/editar/{id}");
    }

    private void SuspenderProduto(ProdutoModel produto)
    {
        tituloModal = "Suspender Produto";
        mensagemModal = $"Tem a certeza que deseja suspender o produto \"{produto.Nome}\"? " +
                       "O produto deixará de estar visível para os clientes.";
        acaoConfirmacao = async () => await ExecutarSuspenderProduto(produto.Id);
        mostrarModalConfirmacao = true;
    }

    private async Task ExecutarSuspenderProduto(int id)
    {
        var (success, error) = await FornecedorService.SuspenderProdutoAsync(id);
        if (success)
        {
            mensagem = "Produto suspenso com sucesso.";
            sucesso = true;
            await CarregarProdutos();
        }
        else
        {
            mensagem = error ?? "Erro ao suspender produto.";
            sucesso = false;
        }
        FecharModal();
    }

    private void ReativarProduto(ProdutoModel produto)
    {
        tituloModal = "Reativar Produto";
        mensagemModal = $"Tem a certeza que deseja reativar o produto \"{produto.Nome}\"? " +
                       "O produto ficará em estado Pendente até ser aprovado novamente.";
        acaoConfirmacao = async () => await ExecutarReativarProduto(produto.Id);
        mostrarModalConfirmacao = true;
    }

    private async Task ExecutarReativarProduto(int id)
    {
        var (success, error) = await FornecedorService.ReativarProdutoAsync(id);
        if (success)
        {
            mensagem = "Produto reativado. Aguarda nova aprovação.";
            sucesso = true;
            await CarregarProdutos();
        }
        else
        {
            mensagem = error ?? "Erro ao reativar produto.";
            sucesso = false;
        }
        FecharModal();
    }

    private void ApagarProduto(ProdutoModel produto)
    {
        tituloModal = "Apagar Produto";
        mensagemModal = $"Tem a certeza que deseja apagar permanentemente o produto \"{produto.Nome}\"? " +
                       "Esta ação não pode ser revertida.";
        acaoConfirmacao = async () => await ExecutarApagarProduto(produto.Id);
        mostrarModalConfirmacao = true;
    }

    private async Task ExecutarApagarProduto(int id)
    {
        var (success, error) = await FornecedorService.ApagarProdutoAsync(id);
        if (success)
        {
            mensagem = "Produto apagado com sucesso.";
            sucesso = true;
            await CarregarProdutos();
        }
        else
        {
            mensagem = error ?? "Erro ao apagar produto. Pode ter vendas associadas.";
            sucesso = false;
        }
        FecharModal();
    }

    private void FecharModal()
    {
        mostrarModalConfirmacao = false;
        acaoConfirmacao = null;
    }

    private async Task ConfirmarAcao()
    {
        if (acaoConfirmacao != null)
        {
            await acaoConfirmacao();
        }
    }

    private string FormatarPreco(decimal preco) => preco.ToString("C", CulturaEuro);

    private string TruncarTexto(string texto, int maxLength)
    {
        if (string.IsNullOrEmpty(texto) || texto.Length <= maxLength)
            return texto;
        return texto.Substring(0, maxLength) + "...";
    }

    private string GetEstadoClasse(string estado) => estado switch
    {
        "Pendente" => "estado-pendente",
        "Ativo" => "estado-ativo",
        "Inativo" => "estado-inativo",
        "Suspenso" => "estado-suspenso",
        _ => ""
    };

    private string GetEstadoIcone(string estado) => estado switch
    {
        "Pendente" => "?",
        "Ativo" => "?",
        "Inativo" => "?",
        "Suspenso" => "??",
        _ => ""
    };
}
