@page "/meus-produtos/criar"
@using System.Globalization
@inject IFornecedorService FornecedorService
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Criar Produto - MyCOLL</PageTitle>

<div class="criar-produto-page">
    <div class="page-header">
        <button class="btn-link" @onclick="Voltar">? Voltar</button>
        <h1>? Novo Produto</h1>
    </div>

    @if (!string.IsNullOrEmpty(erro))
    {
        <div class="alert alert-error">
            @erro
            <button class="alert-close" @onclick="LimparErro">×</button>
        </div>
    }

    <div class="form-card">
        <EditForm Model="model" OnValidSubmit="Submeter" FormName="CriarProdutoForm">
            <DataAnnotationsValidator />

            <div class="form-section">
                <h2>?? Informações Básicas</h2>
                
                <div class="form-group">
                    <label for="nome">Nome do Produto *</label>
                    <InputText id="nome" @bind-Value="model.Nome" class="form-control" 
                               placeholder="Ex: Moeda de 1 Euro - Portugal 2024" />
                    <ValidationMessage For="() => model.Nome" />
                </div>

                <div class="form-group">
                    <label for="Detalhe">Descrição *</label>
                    <InputTextArea id="Detalhe" @bind-Value="model.Detalhe" class="form-control" 
                                   rows="4" placeholder="Descreva o seu produto em detalhe..." />
                    <ValidationMessage For="() => model.Detalhe" />
                </div>
            </div>

            <div class="form-section">
                <h2>??? Imagem</h2>
                
                <div class="form-group">
                    <label>Tipo de Imagem</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="tipoImagem" checked="@(tipoImagem == TipoImagemUrl)" 
                                   @onchange="SelecionarTipoUrl" />
                            <span>URL da Imagem</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="tipoImagem" checked="@(tipoImagem == TipoImagemUpload)"
                                   @onchange="SelecionarTipoUpload" />
                            <span>Upload de Ficheiro</span>
                        </label>
                    </div>
                </div>

                @if (tipoImagem == TipoImagemUrl)
                {
                    <div class="form-group">
                        <label for="urlImagem">URL da Imagem</label>
                        <InputText id="urlImagem" @bind-Value="model.UrlImagem" class="form-control" 
                                   placeholder="https://exemplo.com/imagem.jpg" />
                    </div>
                }
                else
                {
                    <div class="form-group">
                        <label for="ficheiro">Ficheiro de Imagem</label>
                        <InputFile id="ficheiro" OnChange="OnImagemSelecionada" accept="image/*" 
                                   class="form-control-file" />
                        <small class="form-help">Formatos aceites: JPG, PNG, GIF. Máx: 5MB</small>
                    </div>
                }

                @if (!string.IsNullOrEmpty(previewImagem))
                {
                    <div class="imagem-preview">
                        <img src="@previewImagem" alt="Preview" />
                    </div>
                }
            </div>

            <div class="form-section">
                <h2>?? Preço e Stock</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="precoBase">Preço Base (€) *</label>
                        <InputNumber id="precoBase" @bind-Value="model.PrecoBase" class="form-control" 
                                     step="0.01" min="0.01" />
                        <small class="form-help">O preço que deseja receber. A empresa adicionará a sua comissão.</small>
                        <ValidationMessage For="() => model.PrecoBase" />
                    </div>

                    <div class="form-group">
                        <label for="stock">Stock Disponível *</label>
                        <InputNumber id="stock" @bind-Value="model.Stock" class="form-control" 
                                     min="0" />
                        <ValidationMessage For="() => model.Stock" />
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2>?? Classificação</h2>
                
                <div class="form-group">
                    <label for="modo">Modo de Disponibilização *</label>
                    <InputSelect id="modo" @bind-Value="model.ModoDisponibilizacaoId" class="form-control">
                        <option value="0">-- Selecione --</option>
                        @foreach (var modo in modos)
                        {
                            <option value="@modo.Id">@modo.Nome</option>
                        }
                    </InputSelect>
                    <small class="form-help">Venda, Aluguer ou apenas Exposição</small>
                </div>

                <div class="form-group">
                    <label>Categorias</label>
                    <div class="categorias-selector">
                        @foreach (var grupo in categoriasAgrupadas)
                        {
                            <div class="categoria-grupo">
                                <h4>@grupo.Key</h4>
                                <div class="categorias-checkboxes">
                                    @foreach (var cat in grupo.Value)
                                    {
                                        <label class="checkbox-option">
                                            <input type="checkbox" checked="@model.CategoriaIds.Contains(cat.Id)"
                                                   @onchange="e => ToggleCategoria(cat.Id, (bool)e.Value!)" />
                                            <span>@cat.Nome</span>
                                        </label>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" @onclick="Voltar" disabled="@isSubmitting">
                    Cancelar
                </button>
                <button type="submit" class="btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner-small"></span>
                        <text>A criar...</text>
                    }
                    else
                    {
                        <text>? Criar Produto</text>
                    }
                </button>
            </div>
        </EditForm>
    </div>

    <div class="info-box">
        <h3>?? Informação Importante</h3>
        <ul>
            <li>O seu produto ficará em estado <strong>Pendente</strong> até ser aprovado pela administração.</li>
            <li>Após aprovação, será definida a percentagem da empresa e o produto ficará visível para clientes.</li>
            <li>Pode editar o produto a qualquer momento, mas alterações voltarão a requerer aprovação.</li>
        </ul>
    </div>
</div>

@code {
    private const string TipoImagemUrl = "url";
    private const string TipoImagemUpload = "upload";
    
    private CriarProdutoModel model = new();
    private List<ModoDisponibilizacaoModel> modos = new();
    private List<CategoriaModel> categorias = new();
    private Dictionary<string, List<CategoriaModel>> categoriasAgrupadas = new();
    
    private string tipoImagem = TipoImagemUrl;
    private string? previewImagem;
    private string? erro;
    private bool isSubmitting;

    protected override async Task OnInitializedAsync()
    {
        var isAuth = await AuthService.IsAuthenticatedAsync();
        if (!isAuth)
        {
            Navigation.NavigateTo("/login?returnUrl=/meus-produtos/criar");
            return;
        }

        var userInfo = await AuthService.GetUserInfoAsync();
        if (userInfo?.IsFornecedor != true)
        {
            Navigation.NavigateTo("/");
            return;
        }

        modos = await FornecedorService.GetModosDisponibilizacaoAsync();
        categorias = await FornecedorService.GetCategoriasAsync();
        
        categoriasAgrupadas = categorias
            .GroupBy(c => c.Tipo)
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private void SelecionarTipoUrl() => tipoImagem = TipoImagemUrl;
    private void SelecionarTipoUpload() => tipoImagem = TipoImagemUpload;
    private void LimparErro() => erro = null;

    private async Task OnImagemSelecionada(InputFileChangeEventArgs e)
    {
        var file = e.File;
        
        if (file.Size > 5 * 1024 * 1024)
        {
            erro = "O ficheiro é demasiado grande. Máximo: 5MB";
            return;
        }

        var buffer = new byte[file.Size];
        await file.OpenReadStream(5 * 1024 * 1024).ReadAsync(buffer);
        
        model.ImagemBase64 = Convert.ToBase64String(buffer);
        model.UrlImagem = null;
        previewImagem = $"data:{file.ContentType};base64,{model.ImagemBase64}";
    }

    private void ToggleCategoria(int categoriaId, bool selecionado)
    {
        if (selecionado && !model.CategoriaIds.Contains(categoriaId))
        {
            model.CategoriaIds.Add(categoriaId);
        }
        else if (!selecionado && model.CategoriaIds.Contains(categoriaId))
        {
            model.CategoriaIds.Remove(categoriaId);
        }
    }

    private async Task Submeter()
    {
        erro = null;

        if (string.IsNullOrWhiteSpace(model.Nome))
        {
            erro = "O nome do produto é obrigatório.";
            return;
        }

        if (string.IsNullOrWhiteSpace(model.Detalhe))
        {
            erro = "A descrição do produto é obrigatória.";
            return;
        }

        if (model.PrecoBase <= 0)
        {
            erro = "O preço base deve ser maior que zero.";
            return;
        }

        if (model.ModoDisponibilizacaoId == 0)
        {
            erro = "Selecione um modo de disponibilização.";
            return;
        }

        isSubmitting = true;

        try
        {
            if (tipoImagem == TipoImagemUrl)
            {
                model.ImagemBase64 = null;
            }

            var (success, produto, error) = await FornecedorService.CriarProdutoAsync(model);

            if (success)
            {
                Navigation.NavigateTo("/meus-produtos");
            }
            else
            {
                erro = error ?? "Erro ao criar produto. Tente novamente.";
            }
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Voltar()
    {
        Navigation.NavigateTo("/meus-produtos");
    }
}
