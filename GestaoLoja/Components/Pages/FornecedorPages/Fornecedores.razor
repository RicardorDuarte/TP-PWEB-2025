@page "/fornecedores/{fornecedorId}"

@rendermode InteractiveServer

@attribute [Authorize(Roles = "Administrador, Funcionario")]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using GestaoLoja.Data
@using Microsoft.AspNetCore.Identity

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager

<PageTitle>Produtos do Fornecedor</PageTitle>

@if (fornecedor == null)
{
    <p><em>Carregando...</em></p>
}
else
{
    <h1>Produtos de @fornecedor.Nome @fornecedor.Apelido</h1>

    <div class="mb-3">
        <a href="/fornecedores" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Voltar à Lista
        </a>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <h5>Informações do Fornecedor</h5>
            <p><strong>Email:</strong> @fornecedor.Email</p>
            <p><strong>UserName:</strong> @fornecedor.UserName</p>
            <p><strong>Telefone:</strong> @fornecedor.PhoneNumber</p>
            <p><strong>Localidade:</strong> @fornecedor.Localidade, @fornecedor.Pais</p>
            <p><strong>Estado:</strong> <span class="badge @(fornecedor.Estado == "Ativo" ? "bg-success" : "bg-warning")">@fornecedor.Estado</span></p>
        </div>
    </div>

    @if (produtos == null)
    {
        <p><em>Carregando produtos...</em></p>
    }
    else if (!produtos.Any())
    {
        <div class="alert alert-info">
            <p>Este fornecedor não tem produtos.</p>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Imagem</th>
                        <th>Nome</th>
                        <th>Preço Base</th>
                        <th>Preço Final</th>
                        <th>Stock</th>
                        <th>Estado</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in produtos)
                    {
                        <tr>
                            <td>
                                @if (p.Imagem != null && p.Imagem.Length > 0)
                                {
                                    <img src="data:image/*;base64,@(Convert.ToBase64String(p.Imagem))" 
                                         style="width:50px; height:50px; object-fit:cover;" 
                                         alt="@p.Nome" />
                                }
                                else
                                {
                                    <img src="/img/noproductstrans.png" style="width:50px; height:50px;" alt="No image" />
                                }
                            </td>
                            <td>@p.Nome</td>
                            <td>@p.PrecoBase.ToString("C")</td>
                            <td>@p.Preco.ToString("C")</td>
                            <td>@p.Stock</td>
                            <td>
                                <span class="badge @(p.Ativo ? "bg-success" : "bg-warning")">
                                    @(p.Ativo ? "Ativo" : "Inativo")
                                </span>
                            </td>
                            <td>
                                <a href="/produtos/details?id=@p.Id" class="btn btn-sm btn-info">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="/produtos/edit?id=@p.Id" class="btn btn-sm btn-primary">
                                    <i class="bi bi-pencil"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="mt-3">
            <strong>Total de produtos:</strong> @produtos.Count
        </div>
    }
}

@code {
    private List<Entities.Produto>? produtos;
    private ApplicationUser? fornecedor;
    
    [Parameter] 
    public string? fornecedorId { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if (string.IsNullOrWhiteSpace(fornecedorId))
        {
            produtos = new List<Entities.Produto>();
            return;
        }

        fornecedor = await UserManager.FindByIdAsync(fornecedorId);

        if (fornecedor == null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }
        using var context = DbFactory.CreateDbContext();
        produtos = await context.Produtos
            .Where(p => p.FornecedorId == fornecedorId)
            .Include(p => p.categoria)
            .Include(p => p.modoentrega)
            .OrderBy(p => p.Nome)
            .ToListAsync();
    }
}