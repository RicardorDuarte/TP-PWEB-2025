@page "/admin/roles"

@rendermode InteractiveServer 

@attribute [Authorize(Roles = "Administrador")]

@using GestaoLoja.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization

@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager

<PageTitle>Gestão de Roles</PageTitle>

<h3>Gestão de Roles</h3>

<h4>Lista de Roles Existentes</h4>
<!--Lista de Roles que existem-->
@if (roles == null)
{
    <p><em>A carregar Roles...</em></p>
}
else if (roles.Count == 0)
{
    <p><em>Nenhuma role encontrada.</em></p>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Nome da Role</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var role in roles)
                {
                    <tr>
                        <td>@role.Name</td>
                        <td>
                            @* Prevenir eliminação das roles principais *@
                            @if (role.Name == "Administrador" || role.Name == "Funcionario" || role.Name == "Cliente")
                            {
                                <button class="btn btn-danger btn-sm" disabled title="Role do sistema não pode ser eliminada">
                                    <i class="bi bi-trash"></i> Eliminar
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-danger btn-sm" @onclick="async () => await ConfirmarEEliminarRole(role.Name)">
                                    <i class="bi bi-trash"></i> Eliminar
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<!--Formulario para criar Roles-->
<div class="card mt-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Criar Nova Role</h5>
    </div>
    <div class="card-body">
        @if (!string.IsNullOrEmpty(mensagem))
        {
            <div class="alert @(mensagem.Contains("sucesso") ? "alert-success" : "alert-danger")" role="alert">
                @mensagem
            </div>
        }
        
        <div class="mb-3">
            <label for="nomeDaRole" class="form-label">Nome da Role:</label>
            <input type="text" class="form-control" id="nomeDaRole"
                   @bind="newRole"
                   @bind:event="oninput"
                   placeholder="Exemplo: Gerente, Supervisor, etc."
                   maxlength="50" />
            <small class="form-text text-muted">Escolha um nome descritivo para a nova role</small>
        </div>
        <div class="mb-3">
            <button type="button" class="btn btn-primary" @onclick="CriarRole" disabled="@string.IsNullOrWhiteSpace(newRole)">
                <i class="bi bi-save"></i> Criar Role
            </button>
            <button type="button" class="btn btn-secondary ms-2" @onclick="LimparFormulario">
                <i class="bi bi-x-circle"></i> Limpar
            </button>
        </div>
    </div>
</div>

@code {
    string newRole = string.Empty;
    string mensagem = string.Empty;
    List<IdentityRole>? roles;

    protected async Task CarregarDados()
    {
        roles = RoleManager.Roles.OrderBy(r => r.Name).ToList();
    }

    protected override async Task OnInitializedAsync()
    {
        await CarregarDados();
    }

    protected async Task CriarRole()
    {
        mensagem = string.Empty;

        if (string.IsNullOrWhiteSpace(newRole))
        {
            mensagem = "Por favor, insira um nome para a role.";
            return;
        }

        // Normalizar o nome (primeira letra maiúscula)
        string roleNameFormatted = char.ToUpper(newRole[0]) + newRole.Substring(1).ToLower();

        if (await RoleManager.RoleExistsAsync(roleNameFormatted))
        {
            mensagem = $"A Role '{roleNameFormatted}' já existe!";
            return;
        }

        try
        {
            var role = new IdentityRole(roleNameFormatted);
            var result = await RoleManager.CreateAsync(role);

            if (result.Succeeded)
            {
                mensagem = $"✓ Role '{roleNameFormatted}' criada com sucesso!";
                newRole = string.Empty; // Limpar o campo
                await CarregarDados();
            }
            else
            {
                mensagem = $"Erro ao criar a role: {string.Join(", ", result.Errors.Select(e => e.Description))}";
            }
        }
        catch (Exception ex)
        {
            mensagem = $"Erro inesperado: {ex.Message}";
        }
    }

    protected async Task ConfirmarEEliminarRole(string roleName)
    {
        // Using a simple confirmation through the message system
        // In a production app, you might want to use a modal dialog component
        mensagem = $"⚠️ Tem a certeza que deseja eliminar a role '{roleName}'? Clique novamente no botão Eliminar para confirmar.";
        
        // Store the role to delete
        if (roleToDelete == roleName)
        {
            // Second click - actually delete
            await EliminarRole(roleName);
            roleToDelete = null;
        }
        else
        {
            // First click - just show warning
            roleToDelete = roleName;
        }
    }

    private string? roleToDelete = null;

    protected async Task EliminarRole(string roleName)
    {
        mensagem = string.Empty;

        if (string.IsNullOrEmpty(roleName))
        {
            mensagem = "Nome da role inválido.";
            return;
        }

        // Prevenir eliminação de roles do sistema
        if (roleName == "Administrador" || roleName == "Funcionario" || roleName == "Cliente")
        {
            mensagem = "Não é permitido eliminar roles do sistema.";
            return;
        }

        try
        {
            var role = await RoleManager.FindByNameAsync(roleName);
            
            if (role == null)
            {
                mensagem = $"Role '{roleName}' não encontrada.";
                return;
            }

            // Verificar se existem utilizadores com esta role
            var usersInRole = await UserManager.GetUsersInRoleAsync(roleName);
            if (usersInRole.Any())
            {
                mensagem = $"Não é possível eliminar a role '{roleName}' porque existem {usersInRole.Count} utilizador(es) associado(s).";
                return;
            }

            var result = await RoleManager.DeleteAsync(role);
            
            if (result.Succeeded)
            {
                mensagem = $"✓ Role '{roleName}' eliminada com sucesso!";
                await CarregarDados();
            }
            else
            {
                mensagem = $"Erro ao eliminar a role: {string.Join(", ", result.Errors.Select(e => e.Description))}";
            }
        }
        catch (Exception ex)
        {
            mensagem = $"Erro inesperado: {ex.Message}";
        }
    }

    private void LimparFormulario()
    {
        newRole = string.Empty;
        mensagem = string.Empty;
    }
}

