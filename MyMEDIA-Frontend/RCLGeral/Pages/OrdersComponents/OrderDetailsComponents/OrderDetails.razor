@page "/orders/{Id:int}"

@inject IApiServices ApiService
@inject CartService CartService
@inject NavigationManager NavigationManager

<div class="detalhes-encomenda-container">
    @if (encomenda != null)
    {
        <h2>Detalhes da Encomenda #@encomenda.ID</h2>
        <div class="encomenda-info">
            <p><strong>Data:</strong> @encomenda.Data.ToLongDateString()</p>
            <p><strong>Pagamento:</strong> @encomenda.Pago</p>
            <p><strong>Status:</strong> @(encomenda.Estado ?? "N/A")</p>
            <p><strong>Cliente:</strong> @(encomenda.User?.Nome ?? "N/A")</p>
            <p><strong>Total:</strong> @encomenda.PrecoTotal.ToString("C")</p>
            @if (MostrarPortes())
            {
                <p><strong>Portes:</strong> 12,99 €</p>
            }
        </div>

        <h3>Produtos</h3>
        <div class="produtos-lista">
            @if (encomenda.Produtos != null && encomenda.Produtos.Any())
            {
                <table>
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Quantidade</th>
                            <th>Preço Unitário</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var produto in encomenda.Produtos)
                        {
                            <tr>
                                <td>@(produto.Produto?.Nome ?? "N/A")</td>
                                <td>@produto.Quantity</td>
                                <td>@(produto.Produto?.Preco.ToString("C") ?? "N/A")</td>
                                <td>@((produto.Produto?.Preco * produto.Quantity).ToString() ?? "N/A")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p>Nenhum produto encontrado nesta encomenda.</p>
            }
        </div>

        <div class="acoes">
            @if (encomenda.Estado == "Confirmada" && encomenda.Pago == "Por Pagar")
            {
                <button class="btn-confirmar" @onclick="Pagar">Pagar Encomenda</button>
            }
            @if (encomenda.Estado == "Confirmada" && encomenda.Pago == "Pago")
            {
                <button class="btn-confirmar" @onclick="Pagamento">Ver Pagamento</button>
            }
            <button class="btn-voltar" @onclick="Voltar">Voltar para Encomendas</button>
        </div>
    }
    else
    {
        <p>Carregando detalhes da encomenda...</p>
    }
</div>

@code {

    [Parameter]
    public int Id { get; set; }

    private Encomenda? encomenda;

    protected override async Task OnInitializedAsync()
    {
        var response = await ApiService.GetDetalheEncomenda(Id);
        if (response.Data != null)
        {
            encomenda = response.Data;
        }
        else
        {
            Console.WriteLine($"Erro ao carregar encomenda: {response.ErrorMessage}");
        }
    }

    private void Voltar()
    {
        NavigationManager.NavigateTo("/orders");
    }

    private void Pagar(){
        Checkout checkout = new Checkout{
                Pais = "Portugal",
                Morada = "Rua x Freguesia Y",
                CodigoPostal = "3000-166",
                Telefone = "912345678",
                EntregaExpressa = MostrarPortes()
        };

        CartService.SetCheckoutInfo(checkout);
        CartService.SetEncomenda(encomenda!);
        NavigationManager.NavigateTo("/payment");
    }

    private void Pagamento(){
        NavigationManager.NavigateTo($"/payment/{encomenda!.ID}");
    }

    private bool MostrarPortes()
    {
        if (encomenda?.Produtos == null) return false;

        decimal somaProdutos = encomenda.Produtos.Sum(p => (p.Produto?.Preco ?? 0) * p.Quantity);
        return encomenda.PrecoTotal > somaProdutos;
    }
}
